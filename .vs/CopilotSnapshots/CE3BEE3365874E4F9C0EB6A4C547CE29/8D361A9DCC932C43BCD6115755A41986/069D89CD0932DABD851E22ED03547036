using System.IO;
using System.Text;
using elevator_simulation.Models;
using ClosedXML.Excel;

namespace elevator_simulation.Services
{
    /// <summary>
    /// Machine Learning için veri toplama servisi
    /// CSV ve Excel formatında eğitim verisi kaydeder
    /// </summary>
    public class MLDataCollector
    {
        private readonly string _csvFilePath;
        private readonly string _excelFilePath;
        private bool _headerWritten = false;
        private XLWorkbook? _workbook;
        private IXLWorksheet? _worksheet;
        private int _excelRowIndex = 2; // 1. satır header

        public MLDataCollector(string csvFilePath = "ml_training_data.csv", string excelFilePath = "ml_training_data.xlsx")
        {
            _csvFilePath = csvFilePath;
            _excelFilePath = excelFilePath;
            
            // CSV kontrolü
            if (File.Exists(_csvFilePath))
            {
                var firstLine = File.ReadLines(_csvFilePath).FirstOrDefault();
                
                // Eski format header'ı varsa dosyayı sil ve yeniden oluştur
                if (firstLine != null && 
                    (firstLine.Contains("SimulationTime") || firstLine.Contains("Hour,Minute,PickupFloor")))
                {
                    File.Delete(_csvFilePath);
                    WriteCSVHeader();
                }
                else if (firstLine != null && firstLine.Contains("Tarih,Saat"))
                {
                    _headerWritten = true;
                }
                else
                {
                    WriteCSVHeader();
                }
            }
            else
            {
                WriteCSVHeader();
            }
            
            // Excel dosyası oluştur veya aç
            InitializeExcel();
        }

        private void InitializeExcel()
        {
            if (File.Exists(_excelFilePath))
            {
                try
                {
                    _workbook = new XLWorkbook(_excelFilePath);
                    _worksheet = _workbook.Worksheet(1);
                    _excelRowIndex = _worksheet.LastRowUsed()?.RowNumber() + 1 ?? 2;
                }
                catch
                {
                    // Dosya bozuksa yeniden oluştur
                    CreateNewExcelFile();
                }
            }
            else
            {
                CreateNewExcelFile();
            }
        }

        private void CreateNewExcelFile()
        {
            _workbook = new XLWorkbook();
            _worksheet = _workbook.Worksheets.Add("ML Verisi");
            
            // Header'ları yaz
            _worksheet.Cell(1, 1).Value = "Tarih";
            _worksheet.Cell(1, 2).Value = "Saat";
            _worksheet.Cell(1, 3).Value = "Saat (Tam)";
            _worksheet.Cell(1, 4).Value = "Dakika";
            _worksheet.Cell(1, 5).Value = "Çağrı Kat";
            _worksheet.Cell(1, 6).Value = "Asansör Kat";
            _worksheet.Cell(1, 7).Value = "Bekleme (Saniye)";
            _worksheet.Cell(1, 8).Value = "Toplam Yolcu";
            _worksheet.Cell(1, 9).Value = "Asansör Durum";
            
            // Header'ları formatla
            var headerRange = _worksheet.Range("A1:I1");
            headerRange.Style.Font.Bold = true;
            headerRange.Style.Fill.BackgroundColor = XLColor.LightBlue;
            headerRange.Style.Alignment.Horizontal = XLAlignmentHorizontalValues.Center;
            
            _excelRowIndex = 2;
            SaveExcel();
        }

        private void WriteCSVHeader()
        {
            var header = "Tarih,Saat,Saat_Tam,Dakika,Cagri_Kat,Asansor_Kat,Bekleme_Saniye,Toplam_Yolcu,Asansor_Durum";
            File.WriteAllText(_csvFilePath, header + Environment.NewLine, Encoding.UTF8);
            _headerWritten = true;
        }

        /// <summary>
        /// ML veri kaydı oluştur - Hem CSV hem Excel'e yaz
        /// </summary>
        public void RecordRequest(
            TimeSpan simulationTime,
            int pickupFloor,
            int elevatorFloorAtRequest,
            int waitTimeSeconds,
            int totalPassengers,
            string elevatorState)
        {
            // CSV'ye kaydet
            if (!_headerWritten)
            {
                WriteCSVHeader();
            }

            var date = DateTime.Now.ToString("yyyy-MM-dd");
            var time = simulationTime.ToString(@"hh\:mm\:ss");
            
            var line = $"{date},{time},{simulationTime.Hours},{simulationTime.Minutes}," +
                       $"{pickupFloor},{elevatorFloorAtRequest},{waitTimeSeconds}," +
                       $"{totalPassengers},{elevatorState}";

            File.AppendAllText(_csvFilePath, line + Environment.NewLine, Encoding.UTF8);
            
            // Excel'e kaydet
            if (_worksheet != null)
            {
                _worksheet.Cell(_excelRowIndex, 1).Value = date;
                _worksheet.Cell(_excelRowIndex, 2).Value = time;
                _worksheet.Cell(_excelRowIndex, 3).Value = simulationTime.Hours;
                _worksheet.Cell(_excelRowIndex, 4).Value = simulationTime.Minutes;
                _worksheet.Cell(_excelRowIndex, 5).Value = pickupFloor;
                _worksheet.Cell(_excelRowIndex, 6).Value = elevatorFloorAtRequest;
                _worksheet.Cell(_excelRowIndex, 7).Value = waitTimeSeconds;
                _worksheet.Cell(_excelRowIndex, 8).Value = totalPassengers;
                _worksheet.Cell(_excelRowIndex, 9).Value = elevatorState;
                
                // Satırları formatla (zebra striping)
                if (_excelRowIndex % 2 == 0)
                {
                    _worksheet.Range($"A{_excelRowIndex}:I{_excelRowIndex}").Style.Fill.BackgroundColor = XLColor.LightGray;
                }
                
                _excelRowIndex++;
                SaveExcel();
            }
        }

        private void SaveExcel()
        {
            try
            {
                _workbook?.SaveAs(_excelFilePath);
            }
            catch
            {
                // Dosya açıksa veya hata varsa sessizce geç
            }
        }

        /// <summary>
        /// Tüm veriyi temizle (yeni eğitim için)
        /// </summary>
        public void ClearData()
        {
            // CSV temizle
            if (File.Exists(_csvFilePath))
            {
                File.Delete(_csvFilePath);
            }
            _headerWritten = false;
            WriteCSVHeader();
            
            // Excel temizle
            if (File.Exists(_excelFilePath))
            {
                File.Delete(_excelFilePath);
            }
            CreateNewExcelFile();
        }

        /// <summary>
        /// Toplanan veri sayısını döndür
        /// </summary>
        public int GetRecordCount()
        {
            if (!File.Exists(_csvFilePath))
                return 0;

            var lines = File.ReadAllLines(_csvFilePath);
            return Math.Max(0, lines.Length - 1); // Header hariç
        }
        
        /// <summary>
        /// Kaynakları temizle
        /// </summary>
        public void Dispose()
        {
            SaveExcel();
            _workbook?.Dispose();
        }
    }
}

