using System.Collections.ObjectModel;
using System.Windows;
using System.Windows.Input;
using System.Windows.Threading;
using elevator_simulation.Commands;
using elevator_simulation.Models;

namespace elevator_simulation.ViewModels
{
    public class MainViewModel : ViewModelBase
    {
        private readonly ElevatorModel _elevator;
        private readonly DispatcherTimer _timer;
        private DateTime _simulationStartTime;
        private bool _isSimulationRunning;

        private int _currentFloor;
        private string _elevatorState;
        private string _statusMessage;
        private string _totalTime;
        private bool _hasPassenger;

        public ObservableCollection<int> Floors { get; }
        public ICommand FloorClickCommand { get; }

        public int CurrentFloor
        {
            get => _currentFloor;
            set => SetProperty(ref _currentFloor, value);
        }

        public string ElevatorStateDisplay
        {
            get => _elevatorState;
            set => SetProperty(ref _elevatorState, value);
        }

        public string StatusMessage
        {
            get => _statusMessage;
            set => SetProperty(ref _statusMessage, value);
        }

        public string TotalTime
        {
            get => _totalTime;
            set => SetProperty(ref _totalTime, value);
        }

        public bool HasPassenger
        {
            get => _hasPassenger;
            set => SetProperty(ref _hasPassenger, value);
        }

        public MainViewModel()
        {
            _elevator = new ElevatorModel();
            Floors = new ObservableCollection<int>();
            
            // Katları 0'dan 19'a kadar oluştur
            for (int i = 0; i < ElevatorModel.TotalFloors; i++)
            {
                Floors.Add(i);
            }

            FloorClickCommand = new RelayCommand(OnFloorClick, CanSelectFloor);

            _timer = new DispatcherTimer
            {
                Interval = TimeSpan.FromMilliseconds(100)
            };
            _timer.Tick += Timer_Tick;

            // Başlangıç değerleri
            _currentFloor = 0;
            _elevatorState = "Beklemede";
            _statusMessage = "Bir kat seçin";
            _totalTime = "00:00:00";
            _hasPassenger = false;
            _isSimulationRunning = false;
        }

        private bool CanSelectFloor(object? parameter)
        {
            if (parameter is int targetFloor)
            {
                // Asansör meşgul değilse ve farklı bir kat seçildiyse
                return _elevator.State == Models.ElevatorState.Idle && targetFloor != _elevator.CurrentFloor;
            }
            return false;
        }

        private async void OnFloorClick(object? parameter)
        {
            if (parameter is int targetFloor)
            {
                if (!_isSimulationRunning)
                {
                    _simulationStartTime = DateTime.Now;
                    _timer.Start();
                    _isSimulationRunning = true;
                }

                _elevator.TargetFloor = targetFloor;
                
                if (!_elevator.HasPassenger)
                {
                    StatusMessage = $"Yolcuyu almak için {targetFloor}. kata gidiliyor...";
                    await MoveToFloor(targetFloor);
                    await PickUpPassenger();
                    StatusMessage = "Yolcu alındı. Hedef kat seçin.";
                }
                else
                {
                    StatusMessage = $"Yolcuyu {targetFloor}. kata bırakılıyor...";
                    await MoveToFloor(targetFloor);
                    await DropOffPassenger();
                    StatusMessage = "Yolcu bırakıldı. Bir kat seçin.";
                }
            }
        }

        private async Task MoveToFloor(int targetFloor)
        {
            if (_elevator.CurrentFloor < targetFloor)
            {
                _elevator.State = Models.ElevatorState.MovingUp;
                ElevatorStateDisplay = "Yukarı Çıkıyor";
                
                while (_elevator.CurrentFloor < targetFloor)
                {
                    await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.FloorTravelTime));
                    _elevator.CurrentFloor++;
                    CurrentFloor = _elevator.CurrentFloor;
                }
            }
            else if (_elevator.CurrentFloor > targetFloor)
            {
                _elevator.State = Models.ElevatorState.MovingDown;
                ElevatorStateDisplay = "Aşağı İniyor";
                
                while (_elevator.CurrentFloor > targetFloor)
                {
                    await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.FloorTravelTime));
                    _elevator.CurrentFloor--;
                    CurrentFloor = _elevator.CurrentFloor;
                }
            }
        }

        private async Task PickUpPassenger()
        {
            // Kapı açılıyor
            _elevator.State = Models.ElevatorState.DoorOpening;
            ElevatorStateDisplay = "Kapı Açılıyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.DoorOperationTime));

            // Yolcu bekleniyor
            _elevator.State = Models.ElevatorState.WaitingForPassenger;
            ElevatorStateDisplay = "Yolcu Bekleniyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.WaitingTime));

            // Yolcu bindi
            _elevator.HasPassenger = true;
            HasPassenger = true;

            // Kapı kapanıyor
            _elevator.State = Models.ElevatorState.DoorClosing;
            ElevatorStateDisplay = "Kapı Kapanıyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.DoorOperationTime));

            _elevator.State = Models.ElevatorState.Idle;
            ElevatorStateDisplay = "Beklemede";
        }

        private async Task DropOffPassenger()
        {
            // Kapı açılıyor
            _elevator.State = Models.ElevatorState.DoorOpening;
            ElevatorStateDisplay = "Kapı Açılıyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.DoorOperationTime));

            // Yolcu iniyor
            _elevator.State = Models.ElevatorState.WaitingForPassenger;
            ElevatorStateDisplay = "Yolcu İniyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.WaitingTime));

            // Yolcu indi
            _elevator.HasPassenger = false;
            HasPassenger = false;

            // Kapı kapanıyor
            _elevator.State = Models.ElevatorState.DoorClosing;
            ElevatorStateDisplay = "Kapı Kapanıyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.DoorOperationTime));

            _elevator.State = Models.ElevatorState.Idle;
            ElevatorStateDisplay = "Beklemede";
        }

        private void Timer_Tick(object? sender, EventArgs e)
        {
            if (_isSimulationRunning)
            {
                var elapsed = DateTime.Now - _simulationStartTime;
                TotalTime = elapsed.ToString(@"hh\:mm\:ss");
            }
        }
    }
}
