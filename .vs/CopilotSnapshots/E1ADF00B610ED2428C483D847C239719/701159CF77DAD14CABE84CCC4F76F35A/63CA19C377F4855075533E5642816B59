using System.Collections.ObjectModel;
using System.Windows;
using System.Windows.Input;
using System.Windows.Threading;
using elevator_simulation.Commands;
using elevator_simulation.Models;

namespace elevator_simulation.ViewModels
{
    public class MainViewModel : ViewModelBase
    {
        private readonly ElevatorModel _elevator;
        private readonly DispatcherTimer _timer;
        private DateTime _simulationStartTime;
        private bool _isSimulationRunning;

        private int _currentFloor;
        private string _elevatorState;
        private string _statusMessage;
        private string _totalTime;
        private bool _hasPassenger;
        private bool _isInnerPanelOpen; // Yeni: İç panel açık mı?
        private int _callingFloor; // Yeni: Hangi kattan çağrıldı

        public ObservableCollection<int> Floors { get; }
        public ICommand CallElevatorCommand { get; } // Değişti: Dış çağırma butonu
        public ICommand SelectDestinationCommand { get; } // Yeni: İç hedef seçimi

        public int CurrentFloor
        {
            get => _currentFloor;
            set => SetProperty(ref _currentFloor, value);
        }

        public string ElevatorStateDisplay
        {
            get => _elevatorState;
            set => SetProperty(ref _elevatorState, value);
        }

        public string StatusMessage
        {
            get => _statusMessage;
            set => SetProperty(ref _statusMessage, value);
        }

        public string TotalTime
        {
            get => _totalTime;
            set => SetProperty(ref _totalTime, value);
        }

        public bool HasPassenger
        {
            get => _hasPassenger;
            set => SetProperty(ref _hasPassenger, value);
        }

        public bool IsInnerPanelOpen
        {
            get => _isInnerPanelOpen;
            set => SetProperty(ref _isInnerPanelOpen, value);
        }

        public MainViewModel()
        {
            _elevator = new ElevatorModel();
            Floors = new ObservableCollection<int>();
            
            // Katları 0'dan 19'a kadar oluştur
            for (int i = 0; i < ElevatorModel.TotalFloors; i++)
            {
                Floors.Add(i);
            }

            CallElevatorCommand = new RelayCommand(OnCallElevator, CanCallElevator);
            SelectDestinationCommand = new RelayCommand(OnSelectDestination, CanSelectDestination);

            _timer = new DispatcherTimer
            {
                Interval = TimeSpan.FromMilliseconds(100)
            };
            _timer.Tick += Timer_Tick;

            // Başlangıç değerleri
            _currentFloor = 0;
            _elevatorState = "Beklemede";
            _statusMessage = "Asansörü çağırmak için bir kat seçin";
            _totalTime = "00:00:00";
            _hasPassenger = false;
            _isSimulationRunning = false;
            _isInnerPanelOpen = false;
        }

        // DIŞ PANEL - Asansörü çağırma
        private bool CanCallElevator(object? parameter)
        {
            if (parameter is int targetFloor)
            {
                // Asansör boşta olmalı
                return _elevator.State == Models.ElevatorState.Idle && !_hasPassenger;
            }
            return false;
        }

        private async void OnCallElevator(object? parameter)
        {
            if (parameter is int callingFloor)
            {
                if (!_isSimulationRunning)
                {
                    _simulationStartTime = DateTime.Now;
                    _timer.Start();
                    _isSimulationRunning = true;
                }

                _callingFloor = callingFloor;
                StatusMessage = $"{callingFloor}. kattan asansör çağrıldı. Gidiliyor...";
                
                // Asansörü çağıran kata götür
                await MoveToFloor(callingFloor);
                
                // Yolcuyu al
                await PickUpPassenger();
                
                // İç paneli aç (tuş takımı)
                StatusMessage = "Yolcu bindi. Hedef katı seçin.";
                IsInnerPanelOpen = true;
            }
        }

        // İÇ PANEL - Hedef kat seçimi
        private bool CanSelectDestination(object? parameter)
        {
            if (parameter is int targetFloor)
            {
                // Yolcu içeride olmalı ve farklı kat seçilmeli
                return _hasPassenger && targetFloor != _currentFloor;
            }
            return false;
        }

        private async void OnSelectDestination(object? parameter)
        {
            if (parameter is int targetFloor)
            {
                // Paneli kapat
                IsInnerPanelOpen = false;
                
                StatusMessage = $"Hedef: {targetFloor}. kat. Gidiliyor...";
                
                // Hedef kata git
                await MoveToFloor(targetFloor);
                
                // Yolcuyu indir
                await DropOffPassenger();
                
                StatusMessage = "Yolcu indi. Yeni çağrı bekleniyor.";
            }
        }

        private async Task MoveToFloor(int targetFloor)
        {
            if (_elevator.CurrentFloor < targetFloor)
            {
                _elevator.State = Models.ElevatorState.MovingUp;
                ElevatorStateDisplay = "Yukarı Çıkıyor";
                
                while (_elevator.CurrentFloor < targetFloor)
                {
                    await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.FloorTravelTime));
                    _elevator.CurrentFloor++;
                    CurrentFloor = _elevator.CurrentFloor;
                }
            }
            else if (_elevator.CurrentFloor > targetFloor)
            {
                _elevator.State = Models.ElevatorState.MovingDown;
                ElevatorStateDisplay = "Aşağı İniyor";
                
                while (_elevator.CurrentFloor > targetFloor)
                {
                    await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.FloorTravelTime));
                    _elevator.CurrentFloor--;
                    CurrentFloor = _elevator.CurrentFloor;
                }
            }
        }

        private async Task PickUpPassenger()
        {
            // Kapı açılıyor
            _elevator.State = Models.ElevatorState.DoorOpening;
            ElevatorStateDisplay = "Kapı Açılıyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.DoorOperationTime));

            // Yolcu bekleniyor
            _elevator.State = Models.ElevatorState.WaitingForPassenger;
            ElevatorStateDisplay = "Yolcu Biniyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.WaitingTime));

            // Yolcu bindi
            _elevator.HasPassenger = true;
            HasPassenger = true;

            // Kapı kapanıyor
            _elevator.State = Models.ElevatorState.DoorClosing;
            ElevatorStateDisplay = "Kapı Kapanıyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.DoorOperationTime));

            _elevator.State = Models.ElevatorState.Idle;
            ElevatorStateDisplay = "Hedef Bekleniyor";
        }

        private async Task DropOffPassenger()
        {
            // Kapı açılıyor
            _elevator.State = Models.ElevatorState.DoorOpening;
            ElevatorStateDisplay = "Kapı Açılıyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.DoorOperationTime));

            // Yolcu iniyor
            _elevator.State = Models.ElevatorState.WaitingForPassenger;
            ElevatorStateDisplay = "Yolcu İniyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.WaitingTime));

            // Yolcu indi
            _elevator.HasPassenger = false;
            HasPassenger = false;

            // Kapı kapanıyor
            _elevator.State = Models.ElevatorState.DoorClosing;
            ElevatorStateDisplay = "Kapı Kapanıyor";
            await Task.Delay(TimeSpan.FromSeconds(ElevatorModel.DoorOperationTime));

            _elevator.State = Models.ElevatorState.Idle;
            ElevatorStateDisplay = "Beklemede";
        }

        private void Timer_Tick(object? sender, EventArgs e)
        {
            if (_isSimulationRunning)
            {
                var elapsed = DateTime.Now - _simulationStartTime;
                TotalTime = elapsed.ToString(@"hh\:mm\:ss");
            }
        }
    }
}
